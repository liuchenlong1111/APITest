<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®åˆ†ç±»ç­›é€‰æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .section h2 {
            color: #00d4ff;
            margin-top: 0;
        }
        select, button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px;
        }
        button {
            background: #00d4ff;
            color: #000;
            cursor: pointer;
        }
        .result {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #67c23a; }
        .error { border-left: 4px solid #f56c6c; }
        .info { border-left: 4px solid #409eff; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .card h3 {
            color: #00d4ff;
            margin-top: 0;
            font-size: 16px;
        }
        .category-count {
            color: #67c23a;
            font-weight: bold;
        }
        .module-info {
            font-size: 12px;
            color: #888;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é¡¹ç›®åˆ†ç±»ç­›é€‰æµ‹è¯•</h1>
        
        <div class="section">
            <h2>1. é¡¹ç›®é€‰æ‹©</h2>
            <select id="projectSelect">
                <option value="">é€‰æ‹©é¡¹ç›®...</option>
            </select>
            <button onclick="loadProjectData()">åŠ è½½é¡¹ç›®æ•°æ®</button>
            <button onclick="loadAllCategories()">åŠ è½½æ‰€æœ‰åˆ†ç±»</button>
            <div id="projectResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2. åˆ†ç±»ç­›é€‰å¯¹æ¯”</h2>
            <div class="comparison">
                <div>
                    <h3>é¡¹ç›®åˆ†ç±» (åº”è¯¥åªæ˜¾ç¤ºé€‰ä¸­é¡¹ç›®çš„åˆ†ç±»)</h3>
                    <div id="projectCategories" class="result"></div>
                </div>
                <div>
                    <h3>æ‰€æœ‰åˆ†ç±» (å¯¹æ¯”å‚è€ƒ)</h3>
                    <div id="allCategories" class="result"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>3. é¡¹ç›®è¯¦ç»†ä¿¡æ¯</h2>
            <div id="projectDetails" class="grid"></div>
        </div>
    </div>

    <script>
        let projects = [];
        let projectCategories = [];
        let allCategories = [];
        let modules = [];

        // åˆå§‹åŒ–
        async function init() {
            try {
                const response = await fetch('/api/v1/projects/');
                projects = await response.json();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®...</option>';
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (åˆ†ç±»: ${project.category_count}, æ¥å£: ${project.api_count})`;
                    select.appendChild(option);
                });
                
                setResult('projectResult', 'é¡¹ç›®åˆ—è¡¨åŠ è½½å®Œæˆ');
            } catch (error) {
                setResult('projectResult', 'åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é¡¹ç›®æ•°æ®
        async function loadProjectData() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) {
                setResult('projectResult', 'è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'error');
                return;
            }

            setResult('projectResult', 'æ­£åœ¨åŠ è½½é¡¹ç›®æ•°æ®...');

            try {
                // å¹¶è¡ŒåŠ è½½é¡¹ç›®çš„æ¨¡å—å’Œåˆ†ç±»
                const [modulesResponse, categoriesResponse] = await Promise.all([
                    fetch(`/api/v1/projects/${projectId}/modules`),
                    fetch(`/api/v1/apis/categories/?project_id=${projectId}`)
                ]);

                modules = await modulesResponse.json();
                projectCategories = await categoriesResponse.json();

                setResult('projectResult', `é¡¹ç›®æ•°æ®åŠ è½½å®Œæˆ - æ¨¡å—: ${modules.length}, åˆ†ç±»: ${projectCategories.length}`, 'success');
                
                updateProjectCategories();
                updateProjectDetails();
            } catch (error) {
                setResult('projectResult', 'åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ‰€æœ‰åˆ†ç±»
        async function loadAllCategories() {
            try {
                const response = await fetch('/api/v1/apis/categories/');
                allCategories = await response.json();
                
                updateAllCategories();
            } catch (error) {
                setResult('allCategories', 'åŠ è½½æ‰€æœ‰åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é¡¹ç›®åˆ†ç±»æ˜¾ç¤º
        function updateProjectCategories() {
            if (projectCategories.length === 0) {
                setResult('projectCategories', 'è¯¥é¡¹ç›®æš‚æ— åˆ†ç±»', 'info');
                return;
            }

            // æŒ‰æ¨¡å—åˆ†ç»„
            const moduleGroups = {};
            projectCategories.forEach(category => {
                const moduleId = category.module_id;
                if (!moduleGroups[moduleId]) {
                    const module = modules.find(m => m.id === moduleId);
                    moduleGroups[moduleId] = {
                        module: module,
                        categories: []
                    };
                }
                moduleGroups[moduleId].categories.push(category);
            });

            let result = `é¡¹ç›®åˆ†ç±»æ€»æ•°: ${projectCategories.length}\n\n`;
            Object.values(moduleGroups).forEach(group => {
                result += `ğŸ“ æ¨¡å—: ${group.module?.name || 'æœªçŸ¥æ¨¡å—'}\n`;
                group.categories.forEach(cat => {
                    result += `  - ${cat.name} [${cat.color}] (ID: ${cat.id})\n`;
                    if (cat.description) {
                        result += `    æè¿°: ${cat.description}\n`;
                    }
                });
                result += '\n';
            });

            setResult('projectCategories', result, 'success');
        }

        // æ›´æ–°æ‰€æœ‰åˆ†ç±»æ˜¾ç¤º
        function updateAllCategories() {
            if (allCategories.length === 0) {
                setResult('allCategories', 'æš‚æ— åˆ†ç±»æ•°æ®', 'info');
                return;
            }

            let result = `æ‰€æœ‰åˆ†ç±»æ€»æ•°: ${allCategories.length}\n\n`;
            allCategories.forEach(cat => {
                result += `- ${cat.name} [${cat.color}] (ID: ${cat.id}, æ¨¡å—ID: ${cat.module_id})\n`;
                if (cat.description) {
                    result += `  æè¿°: ${cat.description}\n`;
                }
            });

            setResult('allCategories', result, 'info');
        }

        // æ›´æ–°é¡¹ç›®è¯¦ç»†ä¿¡æ¯
        function updateProjectDetails() {
            const projectId = document.getElementById('projectSelect').value;
            const project = projects.find(p => p.id == projectId);
            
            if (!project) return;

            const container = document.getElementById('projectDetails');
            container.innerHTML = `
                <div class="card">
                    <h3>ğŸ“Š é¡¹ç›®ç»Ÿè®¡</h3>
                    <p><strong>é¡¹ç›®åç§°:</strong> ${project.name}</p>
                    <p><strong>æ¨¡å—æ•°é‡:</strong> <span class="category-count">${modules.length}</span></p>
                    <p><strong>åˆ†ç±»æ•°é‡:</strong> <span class="category-count">${projectCategories.length}</span></p>
                    <p><strong>æ¥å£æ•°é‡:</strong> <span class="category-count">${project.api_count || 0}</span></p>
                </div>
                <div class="card">
                    <h3>ğŸ”§ æ¨¡å—åˆ—è¡¨</h3>
                    ${modules.map(module => {
                        const moduleCategories = projectCategories.filter(cat => cat.module_id === module.id);
                        return `
                            <div class="module-info">
                                <strong>${module.name}</strong> - ${moduleCategories.length} ä¸ªåˆ†ç±»
                                <br><small>${module.description || 'æ— æè¿°'}</small>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="card">
                    <h3>ğŸ¯ ç­›é€‰éªŒè¯</h3>
                    <p><strong>æœŸæœ›ç»“æœ:</strong> åªæ˜¾ç¤º "${project.name}" é¡¹ç›®ä¸‹çš„åˆ†ç±»</p>
                    <p><strong>å®é™…ç»“æœ:</strong> ${projectCategories.length} ä¸ªåˆ†ç±»</p>
                    <p><strong>éªŒè¯çŠ¶æ€:</strong> 
                        <span style="color: ${projectCategories.length <= allCategories.length ? '#67c23a' : '#f56c6c'}">
                            ${projectCategories.length <= allCategories.length ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                        </span>
                    </p>
                </div>
            `;
        }

        // å·¥å…·æ–¹æ³•
        function setResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html> 