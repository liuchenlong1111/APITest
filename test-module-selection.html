<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å—é€‰æ‹©æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .section h2 {
            color: #00d4ff;
            margin-top: 0;
        }
        select, button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px;
            min-width: 200px;
        }
        button {
            background: #00d4ff;
            color: #000;
            cursor: pointer;
            min-width: auto;
        }
        .result {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #67c23a; }
        .error { border-left: 4px solid #f56c6c; }
        .info { border-left: 4px solid #409eff; }
        .selection-row {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }
        .selection-item {
            flex: 1;
        }
        .selection-item label {
            display: block;
            margin-bottom: 5px;
            color: #00d4ff;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        .breadcrumb {
            background: #444;
            padding: 10px 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .breadcrumb-item {
            color: #00d4ff;
        }
        .breadcrumb-arrow {
            margin: 0 10px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ æ¨¡å—é€‰æ‹©æµ‹è¯•</h1>
        
        <div class="section">
            <h2>ä¸‰çº§å±‚çº§é€‰æ‹©</h2>
            <div class="selection-row">
                <div class="selection-item">
                    <label>ğŸ—ï¸ é¡¹ç›®é€‰æ‹©</label>
                    <select id="projectSelect">
                        <option value="">é€‰æ‹©é¡¹ç›®...</option>
                    </select>
                </div>
                <div class="selection-item">
                    <label>ğŸ”§ æ¨¡å—é€‰æ‹©</label>
                    <select id="moduleSelect" disabled>
                        <option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>
                    </select>
                </div>
                <div class="selection-item">
                    <label>ğŸ“‚ åˆ†ç±»é€‰æ‹©</label>
                    <select id="categorySelect" disabled>
                        <option value="">è¯·å…ˆé€‰æ‹©æ¨¡å—</option>
                    </select>
                </div>
                <div class="selection-item">
                    <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                </div>
            </div>
            
            <div class="breadcrumb" id="breadcrumb">
                è¯·æŒ‰é¡ºåºé€‰æ‹©é¡¹ç›® â†’ æ¨¡å— â†’ åˆ†ç±»
            </div>
            
            <div id="selectionResult" class="result"></div>
        </div>

        <div class="section">
            <h2>ç­›é€‰ç»Ÿè®¡</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">é¡¹ç›®æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">å½“å‰æ¨¡å—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">å½“å‰åˆ†ç±»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">å½“å‰æ¥å£æ•°</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ç­›é€‰éªŒè¯</h2>
            <div id="validationResult" class="result"></div>
        </div>
    </div>

    <script>
        let projects = [];
        let modules = [];
        let categories = [];
        let apis = [];

        let selectedProject = null;
        let selectedModule = null;
        let selectedCategory = null;

        // åˆå§‹åŒ–
        async function init() {
            try {
                const response = await fetch('/api/v1/projects/');
                projects = await response.json();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®...</option>';
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
                
                updateStats();
                setResult('selectionResult', `åŠ è½½äº† ${projects.length} ä¸ªé¡¹ç›®`, 'success');
            } catch (error) {
                setResult('selectionResult', 'åŠ è½½é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡¹ç›®é€‰æ‹©äº‹ä»¶
        document.getElementById('projectSelect').addEventListener('change', async function() {
            const projectId = this.value;
            selectedProject = projects.find(p => p.id == projectId);
            selectedModule = null;
            selectedCategory = null;
            
            const moduleSelect = document.getElementById('moduleSelect');
            const categorySelect = document.getElementById('categorySelect');
            
            if (projectId) {
                try {
                    setResult('selectionResult', 'æ­£åœ¨åŠ è½½æ¨¡å—...');
                    
                    // åŠ è½½æ¨¡å—
                    const modulesResponse = await fetch(`/api/v1/projects/${projectId}/modules`);
                    modules = await modulesResponse.json();
                    
                    // æ›´æ–°æ¨¡å—é€‰æ‹©å™¨
                    moduleSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡å—...</option>';
                    moduleSelect.disabled = false;
                    modules.forEach(module => {
                        const option = document.createElement('option');
                        option.value = module.id;
                        option.textContent = module.name;
                        moduleSelect.appendChild(option);
                    });
                    
                    // é‡ç½®åˆ†ç±»é€‰æ‹©å™¨
                    categorySelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¨¡å—</option>';
                    categorySelect.disabled = true;
                    categories = [];
                    
                    setResult('selectionResult', `é¡¹ç›® "${selectedProject.name}" æœ‰ ${modules.length} ä¸ªæ¨¡å—`, 'success');
                } catch (error) {
                    setResult('selectionResult', 'åŠ è½½æ¨¡å—å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                // é‡ç½®
                moduleSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>';
                moduleSelect.disabled = true;
                categorySelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¨¡å—</option>';
                categorySelect.disabled = true;
                modules = [];
                categories = [];
            }
            
            updateBreadcrumb();
            updateStats();
        });

        // æ¨¡å—é€‰æ‹©äº‹ä»¶
        document.getElementById('moduleSelect').addEventListener('change', async function() {
            const moduleId = this.value;
            selectedModule = modules.find(m => m.id == moduleId);
            selectedCategory = null;
            
            const categorySelect = document.getElementById('categorySelect');
            
            if (moduleId) {
                try {
                    setResult('selectionResult', 'æ­£åœ¨åŠ è½½åˆ†ç±»...');
                    
                    // åŠ è½½è¯¥æ¨¡å—çš„åˆ†ç±»
                    const categoriesResponse = await fetch(`/api/v1/apis/categories/?module_id=${moduleId}`);
                    categories = await categoriesResponse.json();
                    
                    // æ›´æ–°åˆ†ç±»é€‰æ‹©å™¨
                    categorySelect.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»...</option>';
                    categorySelect.disabled = false;
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                    
                    setResult('selectionResult', `æ¨¡å— "${selectedModule.name}" æœ‰ ${categories.length} ä¸ªåˆ†ç±»`, 'success');
                } catch (error) {
                    setResult('selectionResult', 'åŠ è½½åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                // é‡ç½®åˆ†ç±»é€‰æ‹©å™¨
                categorySelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¨¡å—</option>';
                categorySelect.disabled = true;
                categories = [];
            }
            
            updateBreadcrumb();
            updateStats();
        });

        // åˆ†ç±»é€‰æ‹©äº‹ä»¶
        document.getElementById('categorySelect').addEventListener('change', async function() {
            const categoryId = this.value;
            selectedCategory = categories.find(c => c.id == categoryId);
            
            if (categoryId) {
                try {
                    setResult('selectionResult', 'æ­£åœ¨åŠ è½½æ¥å£...');
                    
                    // åŠ è½½è¯¥åˆ†ç±»çš„æ¥å£
                    const apisResponse = await fetch(`/api/v1/apis/?category_id=${categoryId}`);
                    apis = await apisResponse.json();
                    
                    setResult('selectionResult', `åˆ†ç±» "${selectedCategory.name}" æœ‰ ${apis.length} ä¸ªæ¥å£`, 'success');
                } catch (error) {
                    setResult('selectionResult', 'åŠ è½½æ¥å£å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                apis = [];
            }
            
            updateBreadcrumb();
            updateStats();
            validateSelection();
        });

        // æ›´æ–°é¢åŒ…å±‘
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            let text = '';
            
            if (selectedProject) {
                text += `ğŸ—ï¸ ${selectedProject.name}`;
                
                if (selectedModule) {
                    text += ` â†’ ğŸ”§ ${selectedModule.name}`;
                    
                    if (selectedCategory) {
                        text += ` â†’ ğŸ“‚ ${selectedCategory.name}`;
                    }
                }
            }
            
            breadcrumb.textContent = text || 'è¯·æŒ‰é¡ºåºé€‰æ‹©é¡¹ç›® â†’ æ¨¡å— â†’ åˆ†ç±»';
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${projects.length}</div>
                    <div class="stat-label">é¡¹ç›®æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${modules.length}</div>
                    <div class="stat-label">å½“å‰æ¨¡å—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${categories.length}</div>
                    <div class="stat-label">å½“å‰åˆ†ç±»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${apis.length}</div>
                    <div class="stat-label">å½“å‰æ¥å£æ•°</div>
                </div>
            `;
        }

        // éªŒè¯é€‰æ‹©é€»è¾‘
        function validateSelection() {
            if (!selectedProject || !selectedModule || !selectedCategory) {
                return;
            }

            let validation = `ç­›é€‰è·¯å¾„éªŒè¯:\n`;
            validation += `é¡¹ç›®: ${selectedProject.name} (ID: ${selectedProject.id})\n`;
            validation += `æ¨¡å—: ${selectedModule.name} (ID: ${selectedModule.id})\n`;
            validation += `åˆ†ç±»: ${selectedCategory.name} (ID: ${selectedCategory.id})\n\n`;
            
            validation += `éªŒè¯ç»“æœ:\n`;
            validation += `âœ“ åˆ†ç±»å±äºé€‰ä¸­æ¨¡å—: ${selectedCategory.module_id === selectedModule.id ? 'æ˜¯' : 'å¦'}\n`;
            validation += `âœ“ åˆ†ç±»æ•°é‡ç¬¦åˆé¢„æœŸ: ${categories.length} ä¸ª\n`;
            validation += `âœ“ æ¥å£æ•°é‡: ${apis.length} ä¸ª\n`;

            setResult('validationResult', validation, 'success');
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            await init();
            document.getElementById('projectSelect').value = '';
            document.getElementById('moduleSelect').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©é¡¹ç›®</option>';
            document.getElementById('moduleSelect').disabled = true;
            document.getElementById('categorySelect').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©æ¨¡å—</option>';
            document.getElementById('categorySelect').disabled = true;
            
            selectedProject = null;
            selectedModule = null;
            selectedCategory = null;
            modules = [];
            categories = [];
            apis = [];
            
            updateBreadcrumb();
            updateStats();
            setResult('validationResult', '');
        }

        // å·¥å…·æ–¹æ³•
        function setResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html> 