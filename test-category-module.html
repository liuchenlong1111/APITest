<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»ä¸æ¨¡å—å…³ç³»æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .section h2 {
            color: #00d4ff;
            margin-top: 0;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .card h3 {
            color: #00d4ff;
            margin-top: 0;
            font-size: 16px;
        }
        .category-item {
            background: #444;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #00d4ff;
        }
        .category-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .module-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .api-count {
            font-size: 11px;
            background: #555;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 10px;
        }
        select, button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button {
            background: #00d4ff;
            color: #000;
            cursor: pointer;
        }
        .result {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #67c23a; }
        .error { border-left: 4px solid #f56c6c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— åˆ†ç±»ä¸æ¨¡å—å…³ç³»æµ‹è¯•</h1>
        
        <div class="section">
            <h2>é€‰æ‹©é¡¹ç›®</h2>
            <select id="projectSelect">
                <option value="">é€‰æ‹©é¡¹ç›®...</option>
            </select>
            <button onclick="loadProjectData()">åŠ è½½é¡¹ç›®æ•°æ®</button>
            <div id="status" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ“‚ åˆ†ç±»ä¸æ¨¡å—å…³ç³»</h2>
            <div id="categoryModuleGrid" class="grid">
                <div class="card">è¯·å…ˆé€‰æ‹©é¡¹ç›®</div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”§ æ¨¡å—è¯¦æƒ…</h2>
            <div id="modulesGrid" class="grid">
                <div class="card">è¯·å…ˆé€‰æ‹©é¡¹ç›®</div>
            </div>
        </div>
    </div>

    <script>
        let projects = [];
        let modules = [];
        let categories = [];
        let apis = [];

        // åˆå§‹åŒ–
        async function init() {
            try {
                const response = await fetch('/api/v1/projects/');
                projects = await response.json();
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®...</option>';
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.name} (åˆ†ç±»: ${project.category_count}, æ¥å£: ${project.api_count})`;
                    select.appendChild(option);
                });
                
                setStatus('é¡¹ç›®åˆ—è¡¨åŠ è½½å®Œæˆ');
            } catch (error) {
                setStatus('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é¡¹ç›®æ•°æ®
        async function loadProjectData() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) {
                setStatus('è¯·å…ˆé€‰æ‹©é¡¹ç›®', 'error');
                return;
            }

            setStatus('æ­£åœ¨åŠ è½½é¡¹ç›®æ•°æ®...');

            try {
                // å¹¶è¡ŒåŠ è½½æ¨¡å—ã€åˆ†ç±»ã€æ¥å£
                const [modulesResponse, categoriesResponse, apisResponse] = await Promise.all([
                    fetch(`/api/v1/projects/${projectId}/modules`),
                    fetch(`/api/v1/apis/categories/?project_id=${projectId}`),
                    fetch(`/api/v1/apis/?project_id=${projectId}`)
                ]);

                modules = await modulesResponse.json();
                categories = await categoriesResponse.json();
                apis = await apisResponse.json();

                setStatus(`æ•°æ®åŠ è½½å®Œæˆ - æ¨¡å—: ${modules.length}, åˆ†ç±»: ${categories.length}, æ¥å£: ${apis.length}`, 'success');
                
                updateCategoryModuleGrid();
                updateModulesGrid();
            } catch (error) {
                setStatus('åŠ è½½é¡¹ç›®æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°åˆ†ç±»ä¸æ¨¡å—å…³ç³»ç½‘æ ¼
        function updateCategoryModuleGrid() {
            const container = document.getElementById('categoryModuleGrid');
            
            if (categories.length === 0) {
                container.innerHTML = '<div class="card">è¯¥é¡¹ç›®æš‚æ— åˆ†ç±»</div>';
                return;
            }

            // æŒ‰æ¨¡å—åˆ†ç»„æ˜¾ç¤ºåˆ†ç±»
            const moduleGroups = {};
            categories.forEach(category => {
                const moduleId = category.module_id;
                if (!moduleGroups[moduleId]) {
                    const module = modules.find(m => m.id === moduleId);
                    moduleGroups[moduleId] = {
                        module: module,
                        categories: []
                    };
                }
                moduleGroups[moduleId].categories.push(category);
            });

            container.innerHTML = Object.values(moduleGroups).map(group => {
                return `
                    <div class="card">
                        <h3>ğŸ”§ ${group.module?.name || 'æœªçŸ¥æ¨¡å—'}</h3>
                        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">
                            ${group.module?.description || 'æš‚æ— æè¿°'}
                        </div>
                        ${group.categories.map(category => {
                            const categoryApis = apis.filter(api => api.category_id === category.id);
                            return `
                                <div class="category-item">
                                    <span class="category-color" style="background-color: ${category.color}"></span>
                                    <strong>${category.name}</strong>
                                    <span class="api-count">${categoryApis.length} ä¸ªæ¥å£</span>
                                    <div class="module-info">
                                        ${category.description || 'æš‚æ— æè¿°'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°æ¨¡å—ç½‘æ ¼
        function updateModulesGrid() {
            const container = document.getElementById('modulesGrid');
            
            if (modules.length === 0) {
                container.innerHTML = '<div class="card">è¯¥é¡¹ç›®æš‚æ— æ¨¡å—</div>';
                return;
            }

            container.innerHTML = modules.map(module => {
                const moduleCategories = categories.filter(cat => cat.module_id === module.id);
                const moduleApis = apis.filter(api => 
                    moduleCategories.some(cat => cat.id === api.category_id)
                );
                
                return `
                    <div class="card">
                        <h3>${module.icon || 'ğŸ”§'} ${module.name}</h3>
                        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">
                            ${module.description || 'æš‚æ— æè¿°'}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span style="background: #555; padding: 3px 8px; border-radius: 10px; font-size: 11px;">
                                åˆ†ç±»: ${moduleCategories.length}
                            </span>
                            <span style="background: #555; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;">
                                æ¥å£: ${moduleApis.length}
                            </span>
                        </div>
                        <div style="max-height: 100px; overflow-y: auto;">
                            ${moduleCategories.map(cat => `
                                <div style="font-size: 12px; padding: 2px 0;">
                                    <span style="color: ${cat.color}">â—</span> ${cat.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // è®¾ç½®çŠ¶æ€
        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `result ${type}`;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html> 